namespace q2items
{

const string INVULITEM_NAME			= "item_invulnerability";
const string INVULWEAP_NAME			= "weapon_q2invulnerability";
const float INVUL_DURATION				= 30.0;
const float INVUL_RESPAWN				= 300.0;
const string MODEL_INVUL					= "models/quake2/items/invulner.mdl";
const string INVUL_KVN						= "$i_q2invulnerability";
const string INVUL_KVN_TIME				= "$f_q2invultime";
const string INVUL_KVN_SOUND			= "$f_q2invulsound";
const string INVUL_ICON					= "quake2/pics/p_invulnerability.spr";

final class item_invulnerability : ScriptBaseItemEntity, item_q2pickup
{
	item_invulnerability()
	{
		m_iItemID = IT_ITEM_INVULNERABILITY;
		m_iWorldModelFlags = EF_ROTATE;
		m_sModel = MODEL_INVUL;
		m_sSound = "quake2/items/pkup.wav";
		m_flRespawnTime = INVUL_RESPAWN;
	}
}

class weapon_q2invulnerability : ScriptBasePlayerWeaponEntity
{
	protected CBasePlayer@ m_pPlayer
	{
		get const { return cast<CBasePlayer@>(self.m_hPlayer.GetEntity()); }
		set { self.m_hPlayer = EHandle(@value); }
	}

	void Spawn()
	{
		Precache();
		g_EntityFuncs.SetModel( self, MODEL_INVUL );

		self.FallInit();
	}

	void Precache()
	{
		g_Game.PrecacheModel( MODEL_INVUL );

		g_SoundSystem.PrecacheSound( "quake2/items/protect.wav" );
		g_SoundSystem.PrecacheSound( "quake2/items/protect2.wav" );
		g_SoundSystem.PrecacheSound( "quake2/items/protect4.wav" );

		//Precache these for downloading
		g_Game.PrecacheGeneric( "sprites/quake2/items/" + INVULWEAP_NAME + ".txt" );
		g_Game.PrecacheGeneric( "sprites/quake2/items/invulnerability.spr" );
		g_Game.PrecacheGeneric( "sprites/quake2/pics/p_invulnerability.spr" );
	}

	bool GetItemInfo( ItemInfo& out info )
	{
		info.iMaxAmmo1	= -1;
		info.iMaxClip			= WEAPON_NOCLIP;
		info.iSlot				= INVUL_SLOT - 1;
		info.iPosition			= INVUL_POSITION - 1;
		info.iFlags 				= ITEM_FLAG_SELECTONEMPTY | ITEM_FLAG_NOAUTOSWITCHEMPTY;
		info.iWeight			= 0; //-1 ??

		return true;
	}

	bool AddToPlayer( CBasePlayer@ pPlayer )
	{
		if( !BaseClass.AddToPlayer(pPlayer) )
			return false;

		@m_pPlayer = pPlayer;

		NetworkMessage m1( MSG_ONE, NetworkMessages::WeapPickup, pPlayer.edict() );
			m1.WriteLong( g_ItemRegistry.GetIdForName(INVULWEAP_NAME) );
		m1.End();

		return true;
	}

	bool CanDeploy()
	{
		CustomKeyvalues@ pCustom = m_pPlayer.GetCustomKeyvalues();

		if( pCustom.GetKeyvalue(INVUL_KVN).GetInteger() >= 1 )
			return false;

		return true;
	}

	bool Deploy()
	{
		//it deploys if it's in the player's inventory when they die for some reason....
		if( m_pPlayer.IsAlive() )
		{
			CustomKeyvalues@ pCustom = m_pPlayer.GetCustomKeyvalues();
			HUDNumDisplayParams hudParams;
			q2items::GetHudParams( m_pPlayer, q2items::IT_ITEM_INVULNERABILITY, hudParams );

			float flDuration = INVUL_DURATION;
			if( pCustom.GetKeyvalue(INVUL_KVN).GetInteger() >= 1 )
				flDuration += pCustom.GetKeyvalue(INVUL_KVN_TIME).GetFloat() - g_Engine.time; //add the remaining time

			hudParams.value = flDuration;
			g_PlayerFuncs.HudTimeDisplay( m_pPlayer, hudParams );
			g_SoundSystem.EmitSound( self.edict(), CHAN_ITEM, "quake2/items/protect.wav", VOL_NORM, ATTN_NORM );

			pCustom.SetKeyvalue( INVUL_KVN, 1 );
			pCustom.SetKeyvalue( INVUL_KVN_TIME, g_Engine.time + flDuration ); //start the fading sound

			m_pPlayer.pev.flags |= FL_GODMODE;
			m_pPlayer.pev.renderfx = kRenderFxGlowShell;
			m_pPlayer.pev.rendercolor = Vector( 255, 0, 0 );
			m_pPlayer.pev.renderamt = 1;
			m_pPlayer.SelectLastItem();
			m_pPlayer.SetItemPickupTimes( 0.0 );
		}

		KillSelf();

		return self.DefaultDeploy( "", "", 0, "" );
	}

	void Think()
	{
		if( pev.owner is null )
		{
			g_EntityFuncs.Remove( self );
			return;
		}

		BaseClass.Think();
	}

	CBasePlayerItem@ DropItem() { return null; }

	void KillSelf()
	{
		if( m_pPlayer !is null and m_pPlayer.IsConnected() )
		{
			if( m_pPlayer.HasPlayerItem(self) )
				m_pPlayer.RemovePlayerItem( self );
		}

		g_EntityFuncs.Remove( self );
	}
}
//G_AddBlend(1, 1, 0, 0.08f, ent->client->ps.screen_blend);
void FadeInvulnerability( CBasePlayer@ pPlayer )
{
	CustomKeyvalues@ pCustom = pPlayer.GetCustomKeyvalues();
	float flItemFadeTime= pCustom.GetKeyvalue(INVUL_KVN_TIME).GetFloat();

	if( flItemFadeTime > 0.0 )
	{
		int iItemState = pCustom.GetKeyvalue(INVUL_KVN).GetInteger();

		if( g_Engine.time > (flItemFadeTime - 2.983) and iItemState == 1 )
		{
			InvulFadeMessage( pPlayer );
			g_SoundSystem.EmitSound( pPlayer.edict(), CHAN_ITEM, "quake2/items/protect2.wav", VOL_NORM, ATTN_NORM );
			pCustom.SetKeyvalue( INVUL_KVN, 2 );
		}
		else if( g_Engine.time > flItemFadeTime and iItemState == 2 )
		{
			flItemFadeTime = 0.0;
			InvulResetPlayer( pPlayer );
		}
	}
}

void InvulFadeMessage( CBasePlayer@ pPlayer )
{
	HUDTextParams textParms;
		textParms.fxTime = 30;
		textParms.fadeinTime = 0.0;
		textParms.holdTime = 3.0;
		textParms.fadeoutTime = 0.0;
		textParms.effect = 0;
		textParms.channel = 3;
		textParms.x = 0.25;
		textParms.y = 0.67;
		textParms.r1 = 0;
		textParms.g1 = 255;
		textParms.b1 = 255;
		textParms.r2 = 0;
		textParms.g2 = 0;
		textParms.b2 = 255;

	g_PlayerFuncs.HudMessage( pPlayer, textParms, "Invulnerability is wearing off!\n" );
}

void InvulResetPlayer( CBasePlayer@ pPlayer )
{
	CustomKeyvalues@ pCustom = pPlayer.GetCustomKeyvalues();
	pCustom.SetKeyvalue( INVUL_KVN, 0 );
	pCustom.SetKeyvalue( INVUL_KVN_TIME, 0.0 );
	pPlayer.pev.flags &= ~FL_GODMODE;
	pPlayer.pev.renderfx = kRenderFxNone;
	pPlayer.pev.rendercolor = g_vecZero;
	pPlayer.pev.renderamt = 0;

	g_PlayerFuncs.HudToggleElement( pPlayer, q2items::INVUL_HUD_CHANNEL, false );
}

} //end of namespace q2items